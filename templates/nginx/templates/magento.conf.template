# Upstream blocks for backend services
upstream fastcgi_backend {
 server  ${MAGENTO_PHP_FPM_PORT};
}

# Server block for Magento

server {
 listen 80;
 server_name ${MAGENTO_DOMAIN};
 return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  http2 on;
  server_name ${MAGENTO_DOMAIN};

  set $MAGE_ROOT ${MAGENTO_DIRECTORY};
  include ${MAGENTO_DIRECTORY}/nginx.conf.sample;
  client_max_body_size 25m;

  access_log /var/log/nginx/magento.access.log;
  error_log  /var/log/nginx/magento.error.log;

  # TLS configuration
  ssl_certificate /etc/nginx/certs/${MAGENTO_DOMAIN}/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/${MAGENTO_DOMAIN}/key.pem;
  ssl_trusted_certificate /etc/nginx/certs/${MAGENTO_DOMAIN}/chain.pem;
  ssl_protocols TLSv1.2 TLSv1.3;

  ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384';
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:50m;
  ssl_session_timeout 1d;
}
